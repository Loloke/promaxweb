<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Jelszint Analizátor (MER Kiemeléssel)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Alap stílusok és betűtípus beállítása */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Egyedi stílus a gomboknak */
        .action-button {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: white;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .file-input-button {
            background-color: #4f46e5;
        }
        .file-input-button:hover {
            background-color: #4338ca;
        }
        .pdf-button {
            background-color: #16a34a;
        }
        .pdf-button:hover {
            background-color: #15803d;
        }
        .pdf-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 relative">
        <a href="help.html" target="_blank" class="absolute top-4 right-4 sm:top-6 sm:right-6 lg:top-8 lg:right-8 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow transition-colors duration-200 flex items-center z-10">
            <svg xmlns="http://www.w.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.546-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Súgó
        </a>

        <div id="main-content" class="bg-white rounded-2xl shadow-lg p-6 md:p-8">

            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Mérési Adatok Feldolgozása</h1>
                <p class="mt-2 text-lg text-gray-600">Töltse fel a mérőműszer XML fájljait a jelszintek elemzéséhez.</p>
                <a href="compare.html" class="mt-4 inline-block bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Összehasonlító nézet</a>
            </div>

            <div class="flex flex-col items-center justify-center w-full mb-8">
                <label for="file-upload" class="action-button file-input-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Mérési fájlok kiválasztása (.XML)
                </label>
                <input id="file-upload" type="file" class="hidden" multiple accept=".xml,text/xml">
                <p id="file-info" class="mt-4 text-gray-500">Nincsenek fájlok kiválasztva.</p>
            </div>

            <div id="results-container" class="hidden">
                <div id="graph-section" class="mb-8 pb-6">
                    <h2 class="text-2xl font-semibold text-center mb-4">Csatornák átlagos jelszintje és mérési tartománya</h2>
                    
                    <div class="flex justify-center items-center flex-wrap gap-x-6 gap-y-2 mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="toggle-tilt-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="toggle-tilt-checkbox" class="ml-2 block text-sm text-gray-900 cursor-pointer">Tilt ábrázolása</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="toggle-minmax-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="toggle-minmax-checkbox" class="ml-2 block text-sm text-gray-900 cursor-pointer">Min/Max jelölése</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="toggle-outliers-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="toggle-outliers-checkbox" class="ml-2 block text-sm text-gray-900 cursor-pointer">Szélsőséges értékek szűrése (&gt;30dBuV eltérés)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="toggle-standard-scale-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="toggle-standard-scale-checkbox" class="ml-2 block text-sm text-gray-900 cursor-pointer">Szabványos skála:</label>
                            <input type="number" id="scale-min-input" value="75" class="ml-2 w-20 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" disabled>
                            <label for="scale-min-input" class="ml-1 mr-4 block text-sm text-gray-900">dBuV</label>
                             <div id="narrow-scale-container" class="flex items-center hidden">
                                <input type="checkbox" id="toggle-narrow-scale-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                <label for="toggle-narrow-scale-checkbox" class="ml-2 block text-sm text-gray-900 cursor-pointer">Szűkített (3dBuV)</label>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="toggle-digital-compensation-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="toggle-digital-compensation-checkbox" class="ml-2 block text-sm text-gray-900 cursor-pointer">Digitális jelszint kompenzáció (+3dBuV)</label>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <canvas id="signalChart"></canvas>
                    </div>
                     <div class="flex justify-center flex-wrap mt-4 space-x-4 sm:space-x-6">
                        <div class="flex items-center mb-2 sm:mb-0">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: rgba(79, 70, 229, 0.8);"></div>
                            <span class="text-sm text-gray-600">Analóg csatorna</span>
                        </div>
                        <div class="flex items-center mb-2 sm:mb-0">
                            <div class="w-4 h-4 rounded-full mr-2" style="background-color: rgba(34, 197, 94, 0.8);"></div>
                            <span class="text-sm text-gray-600">DVB-C csatorna</span>
                        </div>
                        <div id="tilt-legend-container" class="flex items-center" style="display: none;">
                             <div class="w-5 h-0.5 mr-2" style="background-color: rgba(220, 38, 38, 1);"></div>
                             <span id="tilt-legend" class="text-sm text-gray-600 font-semibold"></span>
                        </div>
                        <div id="minmax-legend-container" class="flex items-center ml-4" style="display: none;">
                            <div class="w-5 h-0.5 mr-2 border-t-2 border-dashed" style="border-color: rgba(0, 0, 0, 1);"></div>
                            <span id="min-legend" class="text-sm text-gray-600 font-semibold mr-4"></span>
                            <div class="w-5 h-0.5 mr-2 border-t-2 border-dashed" style="border-color: rgba(0, 0, 0, 1);"></div>
                            <span id="max-legend" class="text-sm text-gray-600 font-semibold"></span>
                       </div>
                    </div>
                </div>
                <div id="table-section" class="mb-8">
                    <h2 class="text-2xl font-semibold text-center mb-4">Részletes adatok</h2>
                    <div id="resultsTable" class="overflow-x-auto"></div>
                </div>

                <div class="text-center border-t pt-8 mt-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 max-w-4xl mx-auto">
                        <div>
                            <label for="meresi-hely" class="block text-sm font-medium text-gray-700 text-left mb-1">Mérési hely (pl. Tűzoltóság)</label>
                            <input type="text" id="meresi-hely" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pl. Budapest, Kossuth Lajos utca 1.">
                        </div>
                        <div>
                            <label for="megjegyzes" class="block text-sm font-medium text-gray-700 text-left mb-1">Megjegyzés (pl. Főőrség)</label>
                            <input type="text" id="megjegyzes" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pl. 2. emelet, 3. lakás">
                        </div>
                    </div>
                    <button id="save-pdf-button" class="action-button pdf-button">
                        <svg id="pdf-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span id="pdf-button-text">Mentés PDF-be</span>
                    </button>
                </div>
            </div>

             <div id="loader" class="hidden text-center">
                <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Fájlok feldolgozása...</p>
            </div>

        </div>
    </div>

    <script>
        // --- VÁLTOZÓK ---
        const fileUpload = document.getElementById('file-upload');
        const fileInfo = document.getElementById('file-info');
        const resultsContainer = document.getElementById('results-container');
        const loader = document.getElementById('loader');
        const resultsTable = document.getElementById('resultsTable');
        const savePdfButton = document.getElementById('save-pdf-button');
        const meresiHelyInput = document.getElementById('meresi-hely');
        const megjegyzesInput = document.getElementById('megjegyzes');
        const toggleTiltCheckbox = document.getElementById('toggle-tilt-checkbox');
        const toggleMinMaxCheckbox = document.getElementById('toggle-minmax-checkbox');
        const toggleOutliersCheckbox = document.getElementById('toggle-outliers-checkbox');
        const toggleStandardScaleCheckbox = document.getElementById('toggle-standard-scale-checkbox');
        const scaleMinInput = document.getElementById('scale-min-input');
        const toggleNarrowScaleCheckbox = document.getElementById('toggle-narrow-scale-checkbox');
        const narrowScaleContainer = document.getElementById('narrow-scale-container');
        const toggleDigitalCompensationCheckbox = document.getElementById('toggle-digital-compensation-checkbox');
        let chartInstance = null;
        let processedDataForPdf = [];
        let firstMeasurementTime = null;
        let lastMeasurementTime = null;
        let totalFileCount = 0;
        let rawChannelData = []; // Nyers, beolvasott adatok tárolására

        // --- ESEMÉNYKEZELŐK ---

        // Fájl feltöltés
        fileUpload.addEventListener('change', async (event) => {
            const files = event.target.files;
            totalFileCount = files.length;
            if (totalFileCount > 0) {
                fileInfo.textContent = `${totalFileCount} fájl kiválasztva. Feldolgozás...`;
                resultsContainer.classList.add('hidden');
                loader.classList.remove('hidden');
                toggleTiltCheckbox.checked = false;
                toggleMinMaxCheckbox.checked = false;
                toggleOutliersCheckbox.checked = false;
                toggleStandardScaleCheckbox.checked = false;
                scaleMinInput.disabled = true;
                toggleNarrowScaleCheckbox.checked = false;
                narrowScaleContainer.classList.add('hidden');
                toggleDigitalCompensationCheckbox.checked = false;
                await processFiles(files);
            } else {
                fileInfo.textContent = 'Nincsenek fájlok kiválasztva.';
            }
        });

        // Checkbox-ok változása
        toggleTiltCheckbox.addEventListener('change', () => { if (rawChannelData.length > 0) analyzeAndRender(); });
        toggleMinMaxCheckbox.addEventListener('change', () => { if (rawChannelData.length > 0) analyzeAndRender(); });
        toggleOutliersCheckbox.addEventListener('change', () => { if (rawChannelData.length > 0) analyzeAndRender(); });
        scaleMinInput.addEventListener('input', () => { if (rawChannelData.length > 0 && toggleStandardScaleCheckbox.checked) analyzeAndRender(); });
        toggleNarrowScaleCheckbox.addEventListener('change', () => { if (rawChannelData.length > 0) analyzeAndRender(); });
        toggleDigitalCompensationCheckbox.addEventListener('change', () => { if (rawChannelData.length > 0) analyzeAndRender(); });

        toggleStandardScaleCheckbox.addEventListener('change', () => {
            scaleMinInput.disabled = !toggleStandardScaleCheckbox.checked;
            if (toggleStandardScaleCheckbox.checked) {
                narrowScaleContainer.classList.remove('hidden');
            } else {
                narrowScaleContainer.classList.add('hidden');
                toggleNarrowScaleCheckbox.checked = false;
            }
            if (rawChannelData.length > 0) analyzeAndRender();
        });


        // PDF generálás
        savePdfButton.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const graphSection = document.getElementById('graph-section');
            const button = document.getElementById('save-pdf-button');

            const meresiHelyRaw = meresiHelyInput.value.trim();
            const megjegyzesRaw = megjegyzesInput.value.trim();

            if (!meresiHelyRaw || !megjegyzesRaw) {
                alert("A 'Mérési hely' és a 'Megjegyzés' mezők kitöltése kötelező!");
                return;
            }

            if (processedDataForPdf.length === 0) {
                alert("Nincsenek adatok a PDF generálásához.");
                return;
            }

            button.disabled = true;

            try {
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const margin = 10;
                const contentWidth = pdfWidth - margin * 2;
                let lastY = margin;

                const meresiHely = replaceHungarianChars(meresiHelyRaw);
                const megjegyzes = replaceHungarianChars(megjegyzesRaw);

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(18);
                pdf.text(meresiHely, pdf.internal.pageSize.getWidth() / 2, lastY, { align: 'center' });
                lastY += 8;

                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(12);
                pdf.text(megjegyzes, pdf.internal.pageSize.getWidth() / 2, lastY, { align: 'center' });
                lastY += 8;

                pdf.setFontSize(10);
                const firstMeasurementText = `Elsö mérés: ${formatDateTime(firstMeasurementTime)}`;
                const lastMeasurementText = `Utolsó mérés: ${formatDateTime(lastMeasurementTime)}`;

                pdf.text(replaceHungarianChars(firstMeasurementText), margin, lastY);
                lastY += 6;
                pdf.text(replaceHungarianChars(lastMeasurementText), margin, lastY);
                lastY += 10;
                
                const totalAvgLevelSumPdf = processedDataForPdf.reduce((sum, ch) => sum + ch.avgLevel, 0);
                const overallAvgLevelPdf = processedDataForPdf.length > 0 ? totalAvgLevelSumPdf / processedDataForPdf.length : 0;
                
                const analogChannelsPdf = processedDataForPdf.filter(ch => ch.type === 'ANALOG');
                const digitalChannelsPdf = processedDataForPdf.filter(ch => ch.type === 'DVBC');
                const analogAvgPdf = analogChannelsPdf.length > 0 ? analogChannelsPdf.reduce((sum, ch) => sum + ch.avgLevel, 0) / analogChannelsPdf.length : 0;
                const digitalAvgPdf = digitalChannelsPdf.length > 0 ? digitalChannelsPdf.reduce((sum, ch) => sum + ch.avgLevel, 0) / digitalChannelsPdf.length : 0;

                const overallAvgText = `Teljes atlagos jelszint: ${overallAvgLevelPdf.toFixed(1)} dBuV`;
                const analogAvgText = `Analog atlag: ${analogAvgPdf.toFixed(1)} dBuV`;
                const digitalAvgText = `Digitalis atlag: ${digitalAvgPdf.toFixed(1)} dBuV`;

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.text(replaceHungarianChars(overallAvgText), pdf.internal.pageSize.getWidth() / 2, lastY, { align: 'center' });
                lastY += 8;
                pdf.setFontSize(10);
                pdf.text(replaceHungarianChars(analogAvgText), pdf.internal.pageSize.getWidth() / 2, lastY, { align: 'center' });
                lastY += 6;
                pdf.text(replaceHungarianChars(digitalAvgText), pdf.internal.pageSize.getWidth() / 2, lastY, { align: 'center' });
                lastY += 10;

                const graphCanvas = await html2canvas(graphSection, { scale: 4, logging: false, useCORS: true });
                const graphImgData = graphCanvas.toDataURL('image/jpeg', 0.90);
                const graphRatio = graphCanvas.height / graphCanvas.width;
                const graphImgHeight = contentWidth * graphRatio;

                pdf.addImage(graphImgData, 'JPEG', margin, lastY, contentWidth, graphImgHeight, 'chart', 'SLOW');
                lastY += graphImgHeight + 10;
                
                const showDifferenceColumn = totalFileCount > 1;
                const showMeasurementsColumn = totalFileCount > 1;

                let head = [['Csatorna', 'CH', 'Frekvencia (MHz)', 'Átlag MER (dB)', 'Átlag Jelszint (dBuV)']];
                let columnOrder = ['name', 'standardChannelName', 'displayFrequency', 'avgMer', 'avgLevel'];

                if (showDifferenceColumn) {
                    head[0].splice(4, 0, 'Min Jelszint (dBuV)');
                    head[0].push('Max Jelszint (dBuV)');
                    head[0].push('Különbség (dBuV)');
                    columnOrder.splice(4, 0, 'minLevel');
                    columnOrder.push('maxLevel');
                    columnOrder.push('levelDifference');
                }
                head[0].push('Eltérés az átlagtól (dB)');
                columnOrder.push('deviationFromTotalAvg');

                if (showMeasurementsColumn) {
                    head[0].push('Mérések');
                    columnOrder.push('measurementsDisplay');
                }

                const body = processedDataForPdf.map(ch => {
                    return columnOrder.map(key => {
                        let value = ch[key];
                        if (typeof value === 'number') {
                            if (key === 'deviationFromTotalAvg') {
                                 return (value > 0 ? '+' : '') + value.toFixed(1);
                            }
                            return value.toFixed(2);
                        }
                        if (key === 'avgMer' && value === null) return 'N/A';
                        return replaceHungarianChars(value);
                    });
                });
                
                pdf.autoTable({
                    head: head.map(row => row.map(cell => replaceHungarianChars(cell))),
                    body: body,
                    startY: lastY,
                    theme: 'grid',
                    styles: { font: 'helvetica', fontStyle: 'normal', fontSize: 8 },
                    headStyles: { font: 'helvetica', fontStyle: 'bold', fillColor: [22, 160, 133] },
                    margin: { top: margin, right: margin, bottom: margin, left: margin },
                    didParseCell: function (data) {
                        const rowData = processedDataForPdf[data.row.index];
                        if (!rowData) return;
                        
                        const key = columnOrder[data.column.index];

                        if (key === 'levelDifference' && showDifferenceColumn) {
                            const maxDifferencePdf = Math.max(...processedDataForPdf.map(ch => ch.levelDifference));
                             if (rowData.levelDifference === maxDifferencePdf) {
                                data.cell.styles.textColor = [220, 38, 38];
                                data.cell.styles.fontStyle = 'bold';
                            }
                        }
                        
                        if (key === 'avgMer' && rowData.type === 'DVBC' && rowData.avgMer < 40) {
                             data.cell.styles.textColor = [234, 88, 12];
                             data.cell.styles.fontStyle = 'bold';
                        }

                        if (key === 'deviationFromTotalAvg') {
                            if (rowData.deviationFromTotalAvg > 0) {
                                data.cell.styles.textColor = [22, 163, 74];
                            } else if (rowData.deviationFromTotalAvg < 0) {
                                data.cell.styles.textColor = [220, 38, 38];
                            }
                            data.cell.styles.fontStyle = 'bold';
                        }
                    },
                    didDrawPage: (data) => {
                        const pageCount = pdf.internal.getNumberOfPages();
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(10);
                        pdf.text(replaceHungarianChars(`Oldal ${data.pageNumber} / ${pageCount}`), data.settings.margin.left, pdf.internal.pageSize.height - 10);
                    }
                });

                const today = new Date().toISOString().slice(0, 10);
                pdf.save(`meresi_jegyzek_${today}.pdf`);

            } catch (error) {
                console.error("PDF generálási hiba:", error);
                alert("Hiba történt a PDF generálása során: " + error.message);
            } finally {
                button.disabled = false;
            }
        });


        // --- FŐ FUNKCIÓK ---

        async function processFiles(files) {
            rawChannelData = [];
            const sortedFiles = Array.from(files).sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
            const fileReadPromises = sortedFiles.map(file => readFileAsText(file));

            try {
                const fileContents = await Promise.all(fileReadPromises);
                const parser = new DOMParser();

                for (let i = 0; i < fileContents.length; i++) {
                    const content = fileContents[i];
                    const xmlDoc = parser.parseFromString(content, "text/xml");
                    const { channels, channelTimestamps } = extractDataFromXml(xmlDoc);
                    rawChannelData.push(...channels);
                    if (channelTimestamps.length > 0) {
                        if (i === 0) firstMeasurementTime = channelTimestamps[0];
                        if (i === fileContents.length - 1) lastMeasurementTime = channelTimestamps[channelTimestamps.length - 1];
                    }
                }
                analyzeAndRender();
            } catch (error) {
                console.error("Hiba a fájlok feldolgozása során:", error);
                fileInfo.textContent = "Hiba történt a fájlok feldolgozása közben. Kérjük, ellenőrizze a fájlokat.";
            } finally {
                loader.classList.add('hidden');
            }
        }

        function analyzeAndRender() {
            const { processedChannels, analogAvg, digitalAvg } = processChannelData(rawChannelData, totalFileCount);
            processedDataForPdf = processedChannels;
            renderChart(processedChannels);
            renderTable(processedChannels, totalFileCount, analogAvg, digitalAvg);
            resultsContainer.classList.remove('hidden');
        }

        function processChannelData(allData, fileCount) {
            const channelStats = {};
            allData.forEach(({ channel, level, frequency, type, mer }) => {
                if (!channelStats[channel]) {
                    channelStats[channel] = { levels: [], mers: [], frequency: frequency, type: type };
                }
                channelStats[channel].levels.push(level);
                if (type === 'DVBC' && mer !== null && !isNaN(mer)) {
                    channelStats[channel].mers.push(mer);
                }
            });

            let processedChannels = Object.keys(channelStats).map(channelName => {
                const stats = channelStats[channelName];
                let levelsToProcess = [...stats.levels];
                const originalCount = levelsToProcess.length;
                
                if (fileCount >= 7 && levelsToProcess.length > 4) {
                    levelsToProcess.sort((a, b) => a - b).splice(0, 2);
                    levelsToProcess.splice(-2, 2);
                } else if (fileCount >= 4 && levelsToProcess.length > 2) {
                    levelsToProcess.sort((a, b) => a - b).shift();
                    levelsToProcess.pop();
                }

                const usedCount = levelsToProcess.length;
                const sourceLevels = usedCount > 0 ? levelsToProcess : stats.levels;
                const sumLevel = sourceLevels.reduce((a, b) => a + b, 0);
                const avgLevel = sourceLevels.length > 0 ? sumLevel / sourceLevels.length : 0;
                const minLevel = sourceLevels.length > 0 ? Math.min(...sourceLevels) : 0;
                const maxLevel = sourceLevels.length > 0 ? Math.max(...sourceLevels) : 0;

                const sumMer = stats.mers.reduce((a, b) => a + b, 0);
                const avgMer = stats.mers.length > 0 ? parseFloat((sumMer / stats.mers.length).toFixed(2)) : null;
                const displayFrequency = stats.type === 'ANALOG' ? (stats.frequency - (stats.frequency < 298 ? 7 : 8) / 2 + 1.25) : stats.frequency;
                const standardChannelName = getStandardChannelName(displayFrequency)?.name || 'N/A';

                return { name: channelName, avgLevel: parseFloat(avgLevel.toFixed(2)), minLevel: minLevel, maxLevel: maxLevel, levelDifference: parseFloat((maxLevel - minLevel).toFixed(2)), count: originalCount, measurementsDisplay: `${usedCount}/${originalCount}`, frequency: stats.frequency, displayFrequency: displayFrequency, standardChannelName: standardChannelName, type: stats.type, avgMer: avgMer };
            });
            
            if (toggleOutliersCheckbox.checked && processedChannels.length > 0) {
                 const originalAvgSum = processedChannels.reduce((sum, ch) => sum + ch.avgLevel, 0);
                 const originalOverallAvg = originalAvgSum / processedChannels.length;
                 processedChannels = processedChannels.filter(ch => Math.abs(ch.avgLevel - originalOverallAvg) < 30);
            }

            let analogAvg = 0;
            let digitalAvg = 0;

            if (processedChannels.length > 0) {
                const finalAvgSum = processedChannels.reduce((sum, ch) => sum + ch.avgLevel, 0);
                const finalOverallAvg = finalAvgSum / processedChannels.length;
                processedChannels.forEach(ch => ch.deviationFromTotalAvg = ch.avgLevel - finalOverallAvg);

                const analogChannels = processedChannels.filter(ch => ch.type === 'ANALOG');
                const digitalChannels = processedChannels.filter(ch => ch.type === 'DVBC');

                if (analogChannels.length > 0) {
                    const analogSum = analogChannels.reduce((sum, ch) => sum + ch.avgLevel, 0);
                    analogAvg = analogSum / analogChannels.length;
                }

                if (digitalChannels.length > 0) {
                    const digitalSum = digitalChannels.reduce((sum, ch) => sum + ch.avgLevel, 0);
                    digitalAvg = digitalSum / digitalChannels.length;
                }
            }

            processedChannels.sort((a, b) => a.frequency - b.frequency);
            return { processedChannels, analogAvg, digitalAvg };
        }


        // --- VIZUALIZÁCIÓS FUNKCIÓK ---

        function renderChart(processedData) {
            const ctx = document.getElementById('signalChart').getContext('2d');
            const tiltLegendContainer = document.getElementById('tilt-legend-container');
            const tiltLegendElement = document.getElementById('tilt-legend');
            const showTilt = toggleTiltCheckbox.checked;
            const showMinMax = toggleMinMaxCheckbox.checked;
            const showStandardScale = toggleStandardScaleCheckbox.checked;
            const isNarrowScale = toggleNarrowScaleCheckbox.checked;
            const scaleMin = parseFloat(scaleMinInput.value);
            const compensateDigital = toggleDigitalCompensationCheckbox.checked;

            if (chartInstance) chartInstance.destroy();
            
            const analogColor = 'rgba(79, 70, 229, 0.8)';
            const dvbcColor = 'rgba(34, 197, 94, 0.8)';
            
            const chartData = processedData.map(ch => {
                if (compensateDigital && ch.type === 'DVBC') {
                    return { ...ch, avgLevel: ch.avgLevel + 3 };
                }
                return ch;
            });

            const datasets = [{ label: 'Átlagos jelszint (dBuV)', data: chartData.map(ch => ch.avgLevel), customData: processedData, backgroundColor: processedData.map(ch => ch.type === 'DVBC' ? dvbcColor : analogColor), borderColor: processedData.map(ch => ch.type === 'DVBC' ? 'rgb(22, 163, 74)' : 'rgb(67, 56, 202)'), borderWidth: 1, order: 2 }];

            if (showTilt && processedData.length > 1) {
                const firstLevel = chartData[0].avgLevel;
                const lastLevel = chartData[chartData.length - 1].avgLevel;
                const tilt = lastLevel - firstLevel;
                const lineData = new Array(chartData.length).fill(null);
                lineData[0] = firstLevel;
                lineData[lineData.length - 1] = lastLevel;
                tiltLegendContainer.style.display = 'flex';
                tiltLegendElement.textContent = `Tilt: ${tilt.toFixed(1)} dBuV`; 
                datasets.push({ type: 'line', label: 'Összekötő egyenes', data: lineData, borderColor: 'rgba(220, 38, 38, 0.9)', borderWidth: 2.5, fill: false, tension: 0, pointRadius: 5, pointBackgroundColor: 'rgba(220, 38, 38, 1)', spanGaps: true, order: 1 });
            } else {
                 tiltLegendContainer.style.display = 'none';
            }

            if (showMinMax && chartData.length > 1) {
                const avgLevels = chartData.map(ch => ch.avgLevel);
                const minAvgLevel = Math.min(...avgLevels);
                const maxAvgLevel = Math.max(...avgLevels);

                datasets.push({
                    type: 'line',
                    label: 'Min Átlag',
                    data: new Array(chartData.length).fill(minAvgLevel),
                    borderColor: 'rgba(0, 0, 0, 1)',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    order: 0
                });

                datasets.push({
                    type: 'line',
                    label: 'Max Átlag',
                    data: new Array(chartData.length).fill(maxAvgLevel),
                    borderColor: 'rgba(0, 0, 0, 1)',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    order: 0
                });
                
                const minMaxLegendContainer = document.getElementById('minmax-legend-container');
                minMaxLegendContainer.style.display = 'flex';
                document.getElementById('min-legend').textContent = `Min: ${minAvgLevel.toFixed(1)} dBuV`;
                document.getElementById('max-legend').textContent = `Max: ${maxAvgLevel.toFixed(1)} dBuV`;
            } else {
                const minMaxLegendContainer = document.getElementById('minmax-legend-container');
                if (minMaxLegendContainer) {
                    minMaxLegendContainer.style.display = 'none';
                }
            }
            
            const y_scale_options = { 
                title: { 
                    display: true, 
                    text: 'Jelszint (dBuV)', 
                    font: { size: 14 } 
                } 
            };

            if (showStandardScale && !isNaN(scaleMin)) {
                const scaleRange = isNarrowScale ? 3 : 6;
                y_scale_options.min = scaleMin;
                y_scale_options.max = scaleMin + scaleRange;
            } else {
                 y_scale_options.grace = '10%'; 
                 y_scale_options.beginAtZero = false;
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: processedData.map(ch => ch.name), datasets: datasets },
                plugins: [errorBarPlugin, ChartDataLabels],
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: {
                        y: y_scale_options,
                        x: { title: { display: true, text: 'Csatorna (Frekvencia szerint rendezve)', font: { size: 14 } } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: (context) => context.datasetIndex === 0, rotation: -90, anchor: 'end', align: 'top', offset: 20, color: '#374151', font: { weight: 'bold', size: 13 }, formatter: (value) => value.toFixed(1) },
                        tooltip: {
                            filter: (tooltipItem) => tooltipItem.datasetIndex === 0,
                            callbacks: {
                                label: function(context) {
                                    const channelData = processedData[context.dataIndex];
                                    let lines = [`Átlag: ${channelData.avgLevel} dBuV`];
                                    if (channelData.type === 'DVBC' && channelData.avgMer !== null) lines.push(`Átlag MER: ${channelData.avgMer} dB`);
                                    if (totalFileCount > 1) lines.push(`Min: ${channelData.minLevel} dBuV`, `Max: ${channelData.maxLevel} dBuV`, `Különbség: ${channelData.levelDifference.toFixed(2)} dBuV`);
                                    return lines;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTable(processedData, fileCount, analogAvg, digitalAvg) {
            const showDifferenceColumn = fileCount > 1;
            const showMeasurementsColumn = fileCount > 1;
            const maxDifference = showDifferenceColumn && processedData.length > 0 ? Math.max(...processedData.map(ch => ch.levelDifference)) : 0;
            const totalAvgLevelSum = processedData.reduce((sum, ch) => sum + ch.avgLevel, 0);
            const overallAvgLevel = processedData.length > 0 ? totalAvgLevelSum / processedData.length : 0;

            let tableHTML = `
                <div class="mb-4 text-center">
                    <h3 class="text-lg font-semibold text-gray-800">Teljes átlagos jelszint: <span class="text-indigo-600">${overallAvgLevel.toFixed(1)} dBuV</span></h3>
                    <div class="flex justify-center space-x-4 mt-2">
                        <h4 class="text-md font-semibold text-gray-700">Analóg átlag: <span class="text-blue-600">${analogAvg.toFixed(1)} dBuV</span></h4>
                        <h4 class="text-md font-semibold text-gray-700">Digitális átlag: <span class="text-green-600">${digitalAvg.toFixed(1)} dBuV</span></h4>
                    </div>
                </div>
                <table class="min-w-full divide-y divide-gray-200 bg-white shadow-md rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Csatorna</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CH</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Frekvencia (MHz)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Átlag MER (dB)</th>
                            ${showDifferenceColumn ? '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Min Jelszint (dBuV)</th>' : ''}
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Átlag Jelszint (dBuV)</th>
                            ${showDifferenceColumn ? '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Jelszint (dBuV)</th>' : ''}
                            ${showDifferenceColumn ? '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Különbség (dBuV)</th>' : ''}
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Eltérés az átlagtól (dB)</th>
                            ${showMeasurementsColumn ? '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mérések</th>' : ''}
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            processedData.forEach(ch => {
                let merContent = '<span class="text-gray-400">N/A</span>';
                let merClass = 'text-gray-700';
                if (ch.type === 'DVBC' && ch.avgMer !== null) {
                    merContent = ch.avgMer.toFixed(2);
                    if (ch.avgMer < 40) merClass = 'text-orange-500 font-bold';
                }
                const differenceClass = showDifferenceColumn && ch.levelDifference === maxDifference ? 'text-red-600 font-bold' : 'text-gray-700';
                const deviation = ch.deviationFromTotalAvg;
                const deviationText = (deviation > 0 ? '+' : '') + deviation.toFixed(1);
                const deviationClass = deviation > 0 ? 'text-green-600' : 'text-red-600';

                tableHTML += `<tr><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${ch.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${ch.standardChannelName}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${ch.displayFrequency.toFixed(2)}</td><td class="px-6 py-4 whitespace-nowrap text-sm ${merClass}">${merContent}</td>${showDifferenceColumn ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${ch.minLevel.toFixed(2)}</td>` : ''}<td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-800">${ch.avgLevel.toFixed(2)}</td>${showDifferenceColumn ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${ch.maxLevel.toFixed(2)}</td>` : ''}${showDifferenceColumn ? `<td class="px-6 py-4 whitespace-nowrap text-sm ${differenceClass}">${ch.levelDifference.toFixed(2)}</td>` : ''}<td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${deviationClass}">${deviationText}</td>${showMeasurementsColumn ? `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${ch.measurementsDisplay}</td>` : ''}</tr>`;
            });

            tableHTML += `</tbody></table>`;
            resultsTable.innerHTML = tableHTML;
        }


        // --- SEGÉDFUNKCIÓK ---
        const errorBarPlugin = { id: 'errorBarPlugin', afterDraw(chart) { if (totalFileCount <= 1) return; const { ctx, scales: { x, y } } = chart; ctx.save(); ctx.lineWidth = 1.5; ctx.strokeStyle = 'rgba(220, 38, 38, 0.7)'; chart.data.datasets.forEach((dataset, i) => { if (dataset.type === 'line') return; const customData = dataset.customData; if (!customData) return; for (let j = 0; j < chart.getDatasetMeta(i).data.length; j++) { const bar = chart.getDatasetMeta(i).data[j]; const dataPoint = customData[j]; const xPos = bar.x; const yMin = y.getPixelForValue(dataPoint.minLevel); const yMax = y.getPixelForValue(dataPoint.maxLevel); const whiskerWidth = bar.width * 0.3; ctx.beginPath(); ctx.moveTo(xPos, yMin); ctx.lineTo(xPos, yMax); ctx.stroke(); ctx.beginPath(); ctx.moveTo(xPos - whiskerWidth / 2, yMax); ctx.lineTo(xPos + whiskerWidth / 2, yMax); ctx.stroke(); ctx.beginPath(); ctx.moveTo(xPos - whiskerWidth / 2, yMin); ctx.lineTo(xPos + whiskerWidth / 2, yMin); ctx.stroke(); } }); ctx.restore(); } };
        function readFileAsText(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = () => reject(reader.error); reader.readAsText(file); }); }
        function extractDataFromXml(xmlDoc) { const data = [], channelTimestamps = []; xmlDoc.querySelectorAll('CHANNEL').forEach(channel => { const dateStr = channel.getAttribute('date'), timeStr = channel.getAttribute('time'); if (dateStr && timeStr) { const parsedDate = new Date(`${dateStr}T${timeStr}Z`); if (!isNaN(parsedDate)) channelTimestamps.push(parsedDate); } if (channel.querySelector('STATUS')?.getAttribute('locked') !== 'LOCKED') return; const channelName = channel.getAttribute('name'); const frequency = parseFloat(channel.getAttribute('frequency')); const levelEl = channel.querySelector('MEASURES > LEVEL, MEASURES > POWER'); const level = levelEl ? parseFloat(levelEl.getAttribute('value')) : null; let type = 'ANALOG', mer = null; if (channel.querySelector('DVB-C')) { type = 'DVBC'; const merEl = channel.querySelector('MEASURES > MER'); if (merEl) mer = parseFloat(merEl.getAttribute('value')); } if (channelName && !isNaN(level) && !isNaN(frequency)) { data.push({ channel: channelName, level, frequency, type, mer }); } }); return { channels: data, channelTimestamps }; }
        function getStandardChannelName(freqMHz) {
            const channels = [
                { name: 'E2', start: 44.75, end: 51.75 }, { name: 'E3', start: 51.75, end: 58.75 },
                { name: 'E4', start: 58.75, end: 65.75 }, { name: 'S2', start: 108.75, end: 115.75 },
                { name: 'S3', start: 115.75, end: 122.75 }, { name: 'S4', start: 122.75, end: 129.75 },
                { name: 'S5', start: 129.75, end: 136.75 }, { name: 'S6', start: 136.75, end: 143.75 },
                { name: 'S7', start: 143.75, end: 150.75 }, { name: 'S8', start: 150.75, end: 157.75 },
                { name: 'S9', start: 157.75, end: 164.75 }, { name: 'S10', start: 164.75, end: 171.75 },
                { name: 'E5', start: 171.75, end: 178.75 }, { name: 'E6', start: 178.75, end: 185.75 },
                { name: 'E7', start: 185.75, end: 192.75 }, { name: 'E8', start: 192.75, end: 199.75 },
                { name: 'E9', start: 199.75, end: 206.75 }, { name: 'E10', start: 206.75, end: 213.75 },
                { name: 'E11', start: 213.75, end: 220.75 }, { name: 'E12', start: 220.75, end: 227.75 },
                { name: 'S11', start: 227.75, end: 234.75 }, { name: 'S12', start: 234.75, end: 241.75 },
                { name: 'S13', start: 241.75, end: 248.75 }, { name: 'S14', start: 248.75, end: 255.75 },
                { name: 'S15', start: 255.75, end: 262.75 }, { name: 'S16', start: 262.75, end: 269.75 },
                { name: 'S17', start: 269.75, end: 276.75 }, { name: 'S18', start: 276.75, end: 283.75 },
                { name: 'S19', start: 283.75, end: 290.75 }, { name: 'S20', start: 290.75, end: 297.75 },
                { name: 'S21', start: 298.75, end: 306.75 }, { name: 'S22', start: 306.75, end: 314.75 },
                { name: 'S23', start: 314.75, end: 322.75 }, { name: 'S24', start: 322.75, end: 330.75 },
                { name: 'S25', start: 330.75, end: 338.75 }, { name: 'S26', start: 338.75, end: 346.75 },
                { name: 'S27', start: 346.75, end: 354.75 }, { name: 'S28', start: 354.75, end: 362.75 },
                { name: 'S29', start: 362.75, end: 370.75 }, { name: 'S30', start: 370.75, end: 378.75 },
                { name: 'S31', start: 378.75, end: 386.75 }, { name: 'S32', start: 386.75, end: 394.75 },
                { name: 'S33', start: 394.75, end: 402.75 }, { name: 'S34', start: 402.75, end: 410.75 },
                { name: 'S35', start: 410.75, end: 418.75 }, { name: 'S36', start: 418.75, end: 426.75 },
                { name: 'S37', start: 426.75, end: 434.75 }, { name: 'S38', start: 434.75, end: 442.75 },
                { name: 'S39', start: 442.75, end: 450.75 }, { name: 'S40', start: 450.75, end: 458.75 },
                { name: 'S41', start: 458.75, end: 466.75 }, { name: 'E21', start: 466.75, end: 474.75 },
                { name: 'E22', start: 474.75, end: 482.75 }, { name: 'E23', start: 482.75, end: 490.75 },
                { name: 'E24', start: 490.75, end: 498.75 }, { name: 'E25', start: 498.75, end: 506.75 },
                { name: 'E26', start: 506.75, end: 514.75 }, { name: 'E27', start: 514.75, end: 522.75 },
                { name: 'E28', start: 522.75, end: 530.75 }, { name: 'E29', start: 530.75, end: 538.75 },
                { name: 'E30', start: 538.75, end: 546.75 }, { name: 'E31', start: 546.75, end: 554.75 },
                { name: 'E32', start: 554.75, end: 562.75 }, { name: 'E33', start: 562.75, end: 570.75 },
                { name: 'E34', start: 570.75, end: 578.75 }, { name: 'E35', start: 578.75, end: 586.75 },
                { name: 'E36', start: 586.75, end: 594.75 }, { name: 'E37', start: 594.75, end: 602.75 },
                { name: 'E38', start: 602.75, end: 610.75 }, { name: 'E39', start: 610.75, end: 618.75 },
                { name: 'E40', start: 618.75, end: 626.75 }, { name: 'E41', start: 626.75, end: 634.75 },
                { name: 'E42', start: 634.75, end: 642.75 }, { name: 'E43', start: 642.75, end: 650.75 },
                { name: 'E44', start: 650.75, end: 658.75 }, { name: 'E45', start: 658.75, end: 666.75 },
                { name: 'E46', start: 666.75, end: 674.75 }, { name: 'E47', start: 674.75, end: 682.75 },
                { name: 'E48', start: 682.75, end: 690.75 }, { name: 'E49', start: 690.75, end: 698.75 },
                { name: 'E50', start: 698.75, end: 706.75 }, { name: 'E51', start: 706.75, end: 714.75 },
                { name: 'E52', start: 714.75, end: 722.75 }, { name: 'E53', start: 722.75, end: 730.75 },
                { name: 'E54', start: 730.75, end: 738.75 }, { name: 'E55', start: 738.75, end: 746.75 },
                { name: 'E56', start: 746.75, end: 754.75 }, { name: 'E57', start: 754.75, end: 762.75 },
                { name: 'E58', start: 762.75, end: 770.75 }, { name: 'E59', start: 770.75, end: 778.75 },
                { name: 'E60', start: 778.75, end: 786.75 }, { name: 'E61', start: 786.75, end: 794.75 },
                { name: 'E62', start: 794.75, end: 802.75 }, { name: 'E63', start: 802.75, end: 810.75 },
                { name: 'E64', start: 810.75, end: 818.75 }, { name: 'E65', start: 818.75, end: 826.75 },
                { name: 'E66', start: 826.75, end: 834.75 }, { name: 'E67', start: 834.75, end: 842.75 },
                { name: 'E68', start: 842.75, end: 850.75 }, { name: 'E69', start: 850.75, end: 858.75 }
            ];
            return channels.find(ch => freqMHz >= ch.start && freqMHz < ch.end);
        }
        function formatDateTime(date) { if (!date) return 'N/A'; return date.toLocaleString('hu-HU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
        function replaceHungarianChars(str) { if (typeof str !== 'string') return str; return str.replace(/ő/g, 'ö').replace(/ű/g, 'ü').replace(/Ő/g, 'Ö').replace(/Ű/g, 'Ü'); }
    </script>
</body>
</html>

